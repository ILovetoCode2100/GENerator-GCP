# API CLI Generator - Virtuoso Edition

**Created:** 2025-07-08  
**Purpose:** Generate intelligent orchestration CLI for Virtuoso API
**Status:** Configured with Virtuoso credentials

## ðŸŽ¯ Overview

This project creates a secure, intelligent CLI for the Virtuoso API that:
- Handles complex multi-step workflows automatically
- Enforces business rules (auto-attach, initial resources)
- Supports batch creation from JSON/YAML files
- Provides AI-friendly interfaces and output

## âš¡ Quick Start

```bash
# Set up environment
source ./scripts/setup-virtuoso.sh

# Create project structure from JSON
./bin/api-cli create-structure --file structure.json

# Add test steps
./bin/api-cli add-step <checkpoint-id> navigate --url "https://example.com"
./bin/api-cli add-step <checkpoint-id> click --selector "#button"
```

See [VIRTUOSO_QUICK_START.md](VIRTUOSO_QUICK_START.md) for detailed usage.

## ðŸ“š Documentation

- [COMMANDS.md](COMMANDS.md) - Complete command reference
- [BATCH_FEATURES_GUIDE.md](BATCH_FEATURES_GUIDE.md) - Batch structure creation guide
- [VIRTUOSO_CLI_SUMMARY.md](VIRTUOSO_CLI_SUMMARY.md) - Implementation summary
- [examples/](examples/) - Example structure files

## ðŸ”§ Virtuoso Configuration

The CLI is pre-configured for Virtuoso API:

```yaml
Base URL: https://api-app2.virtuoso.qa/api
Org ID: 2242
Headers:
  X-Virtuoso-Client-ID: api-cli-generator
  X-Virtuoso-Client-Name: api-cli-generator
```

Configuration stored in:
- `/config/virtuoso-config.yaml` - Main config file
- Environment variables (prefix: `VIRTUOSO_`)

## ðŸ—ï¸ Architecture

```
OpenAPI Spec â†’ Code Generation â†’ Go CLI â†’ Multiple Deployment Targets
    â”‚               â”‚                â”‚
    â”‚               â”‚                â”œâ”€â”€ Local Binary
    â”‚               â”‚                â”œâ”€â”€ Docker Container
    â”‚               â”‚                â””â”€â”€ Web Service (optional)
    â”‚               â”‚
    â”‚               â””â”€â”€ oapi-codegen (generates client + types)
    â”‚
    â””â”€â”€ Version controlled, immutable source of truth
```

## ðŸ“ Project Structure

```
api-cli-generator/
â”œâ”€â”€ README.md                # This file
â”œâ”€â”€ go.mod                   # Go module definition
â”œâ”€â”€ Makefile                 # Build automation
â”œâ”€â”€ specs/                   # OpenAPI specifications
â”‚   â””â”€â”€ api.yaml            # Your OpenAPI spec (from Postman)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cmd/                # CLI commands
â”‚   â”‚   â””â”€â”€ root.go         # Main command structure
â”‚   â”œâ”€â”€ api/                # Generated API client code
â”‚   â”‚   â”œâ”€â”€ client.gen.go   # Generated by oapi-codegen
â”‚   â”‚   â””â”€â”€ types.gen.go    # Generated types
â”‚   â”œâ”€â”€ client/             # Enhanced client wrapper
â”‚   â”‚   â””â”€â”€ client.go       # Adds retry, logging, etc.
â”‚   â””â”€â”€ templates/          # Request templates
â”‚       â””â”€â”€ templates.go    # Template management
â”œâ”€â”€ config/                 # Configuration files
â”‚   â””â”€â”€ config.yaml        # Default configuration
â”œâ”€â”€ scripts/               # Build and utility scripts
â”‚   â”œâ”€â”€ generate.sh        # Run code generation
â”‚   â””â”€â”€ validate-spec.sh   # Validate OpenAPI spec
â”œâ”€â”€ docs/                  # Documentation
â”‚   â””â”€â”€ usage.md          # CLI usage guide
â””â”€â”€ examples/             # Example usage
    â””â”€â”€ example-calls.sh  # Sample CLI invocations
```

## ðŸ› ï¸ Technology Stack

- **Language:** Go 1.21+
- **OpenAPI Tool:** oapi-codegen (v2)
- **CLI Framework:** Cobra + Viper
- **HTTP Client:** Generated client + go-resty
- **Templating:** Go text/template
- **Container:** Alpine-based Docker image

## ðŸš€ Quick Start

1. **Place your OpenAPI spec**
   ```bash
   cp your-api.yaml specs/api.yaml
   ```

2. **Generate code**
   ```bash
   make generate
   ```

3. **Build CLI**
   ```bash
   make build
   ```

4. **Run locally**
   ```bash
   ./bin/api-cli --help
   ```

## ðŸ”’ Security Features

- **Immutable Definitions:** API shapes compiled into binary
- **Template Injection Prevention:** Strict parameter validation
- **No Dynamic Endpoints:** All paths fixed at build time
- **Minimal Attack Surface:** Only data values accepted at runtime

## ðŸ“‹ Workflow

### 1. Export from Postman
- Export collection as OpenAPI 3.0
- Place in `specs/api.yaml`
- Validate with `scripts/validate-spec.sh`

### 2. Generate Client Code
```bash
oapi-codegen -package api -generate types,client specs/api.yaml > src/api/client.gen.go
```

### 3. Build CLI Commands
- Each operation becomes a Cobra command
- Parameters mapped to CLI flags
- Templates for request bodies

### 4. Deploy
- **Local:** Single binary
- **Container:** `docker build -t api-cli .`
- **Service:** Thin HTTP wrapper around CLI

## ðŸ“‹ Implementation Status

### Phase 1: Basic Commands âœ…
- [x] Create Project
- [x] Create Goal (with auto-journey creation)
- [x] Create Journey
- [x] Create Checkpoint (with auto-attach)
- [x] Add Step (all types: click, fill, wait, press, navigate)

### Phase 2: Orchestration âœ…
- [x] Create Structure (batch from YAML/JSON)
- [x] Journey renaming and management
- [x] Navigation URL updates
- [x] Workflow automation
- [x] Business rule enforcement

### Phase 3: Enhanced Features âœ…
- [x] List commands (projects, goals, journeys, checkpoints)
- [x] Update commands (journey title, navigation URL)
- [x] Get commands (step details with canonical ID)
- [x] Dry-run mode for previewing changes
- [x] Multiple output formats (human, json, yaml, ai)

## ðŸ”— Dependencies

```go
// Key dependencies
github.com/deepmap/oapi-codegen/v2
github.com/spf13/cobra
github.com/spf13/viper
github.com/go-resty/resty/v2
```

## ðŸ“š References

- [oapi-codegen Documentation](https://github.com/deepmap/oapi-codegen)
- [Cobra CLI Guide](https://cobra.dev/)
- [OpenAPI 3.0 Specification](https://swagger.io/specification/)
