# API CLI Generator - Virtuoso Edition

**Created:** 2025-07-08  
**Purpose:** Generate intelligent orchestration CLI for Virtuoso API
**Status:** Configured with Virtuoso credentials

## 🎯 Overview

This project creates a secure, intelligent CLI for the Virtuoso API that:
- Handles complex multi-step workflows automatically
- Enforces business rules (auto-attach, initial resources)
- Supports batch creation from JSON/YAML files
- Provides AI-friendly interfaces and output

## ⚡ Quick Start

```bash
# Set up environment
source ./scripts/setup-virtuoso.sh

# Create project structure from JSON
./bin/api-cli create-structure --file structure.json

# Add test steps
./bin/api-cli add-step <checkpoint-id> navigate --url "https://example.com"
./bin/api-cli add-step <checkpoint-id> click --selector "#button"
```

See [VIRTUOSO_QUICK_START.md](VIRTUOSO_QUICK_START.md) for detailed usage.

## 📚 Documentation

- [COMMANDS.md](COMMANDS.md) - Complete command reference
- [BATCH_FEATURES_GUIDE.md](BATCH_FEATURES_GUIDE.md) - Batch structure creation guide
- [VIRTUOSO_CLI_SUMMARY.md](VIRTUOSO_CLI_SUMMARY.md) - Implementation summary
- [examples/](examples/) - Example structure files

## 🔧 Virtuoso Configuration

The CLI is pre-configured for Virtuoso API:

```yaml
Base URL: https://api-app2.virtuoso.qa/api
Org ID: 2242
Headers:
  X-Virtuoso-Client-ID: api-cli-generator
  X-Virtuoso-Client-Name: api-cli-generator
```

Configuration stored in:
- `/config/virtuoso-config.yaml` - Main config file
- Environment variables (prefix: `VIRTUOSO_`)

## 🏗️ Architecture

```
OpenAPI Spec → Code Generation → Go CLI → Multiple Deployment Targets
    │               │                │
    │               │                ├── Local Binary
    │               │                ├── Docker Container
    │               │                └── Web Service (optional)
    │               │
    │               └── oapi-codegen (generates client + types)
    │
    └── Version controlled, immutable source of truth
```

## 📁 Project Structure

```
api-cli-generator/
├── README.md                # This file
├── go.mod                   # Go module definition
├── Makefile                 # Build automation
├── specs/                   # OpenAPI specifications
│   └── api.yaml            # Your OpenAPI spec (from Postman)
├── src/
│   ├── cmd/                # CLI commands
│   │   └── root.go         # Main command structure
│   ├── api/                # Generated API client code
│   │   ├── client.gen.go   # Generated by oapi-codegen
│   │   └── types.gen.go    # Generated types
│   ├── client/             # Enhanced client wrapper
│   │   └── client.go       # Adds retry, logging, etc.
│   └── templates/          # Request templates
│       └── templates.go    # Template management
├── config/                 # Configuration files
│   └── config.yaml        # Default configuration
├── scripts/               # Build and utility scripts
│   ├── generate.sh        # Run code generation
│   └── validate-spec.sh   # Validate OpenAPI spec
├── docs/                  # Documentation
│   └── usage.md          # CLI usage guide
└── examples/             # Example usage
    └── example-calls.sh  # Sample CLI invocations
```

## 🛠️ Technology Stack

- **Language:** Go 1.21+
- **OpenAPI Tool:** oapi-codegen (v2)
- **CLI Framework:** Cobra + Viper
- **HTTP Client:** Generated client + go-resty
- **Templating:** Go text/template
- **Container:** Alpine-based Docker image

## 🚀 Quick Start

1. **Place your OpenAPI spec**
   ```bash
   cp your-api.yaml specs/api.yaml
   ```

2. **Generate code**
   ```bash
   make generate
   ```

3. **Build CLI**
   ```bash
   make build
   ```

4. **Run locally**
   ```bash
   ./bin/api-cli --help
   ```

## 🔒 Security Features

- **Immutable Definitions:** API shapes compiled into binary
- **Template Injection Prevention:** Strict parameter validation
- **No Dynamic Endpoints:** All paths fixed at build time
- **Minimal Attack Surface:** Only data values accepted at runtime

## 📋 Workflow

### 1. Export from Postman
- Export collection as OpenAPI 3.0
- Place in `specs/api.yaml`
- Validate with `scripts/validate-spec.sh`

### 2. Generate Client Code
```bash
oapi-codegen -package api -generate types,client specs/api.yaml > src/api/client.gen.go
```

### 3. Build CLI Commands
- Each operation becomes a Cobra command
- Parameters mapped to CLI flags
- Templates for request bodies

### 4. Deploy
- **Local:** Single binary
- **Container:** `docker build -t api-cli .`
- **Service:** Thin HTTP wrapper around CLI

## 📋 Implementation Status

### Phase 1: Basic Commands ✅
- [x] Create Project
- [x] Create Goal (with auto-journey creation)
- [x] Create Journey
- [x] Create Checkpoint (with auto-attach)
- [x] Add Step (all types: click, fill, wait, press, navigate)

### Phase 2: Orchestration ✅
- [x] Create Structure (batch from YAML/JSON)
- [x] Journey renaming and management
- [x] Navigation URL updates
- [x] Workflow automation
- [x] Business rule enforcement

### Phase 3: Enhanced Features ✅
- [x] List commands (projects, goals, journeys, checkpoints)
- [x] Update commands (journey title, navigation URL)
- [x] Get commands (step details with canonical ID)
- [x] Dry-run mode for previewing changes
- [x] Multiple output formats (human, json, yaml, ai)

## 🔗 Dependencies

```go
// Key dependencies
github.com/deepmap/oapi-codegen/v2
github.com/spf13/cobra
github.com/spf13/viper
github.com/go-resty/resty/v2
```

## 📚 References

- [oapi-codegen Documentation](https://github.com/deepmap/oapi-codegen)
- [Cobra CLI Guide](https://cobra.dev/)
- [OpenAPI 3.0 Specification](https://swagger.io/specification/)
