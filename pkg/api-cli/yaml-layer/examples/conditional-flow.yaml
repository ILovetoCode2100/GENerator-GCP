# Conditional flow with error handling
test: Adaptive Checkout Flow
nav: /products
retry: 2

vars:
  acceptCookies: true
  preferredShipping: express

do:
  # Handle cookie banner if present
  - try:
      - wait: .cookie-banner
      - if: {equals: [$acceptCookies, true]}
        then:
          - c: Accept All
        else:
          - c: Reject All
    catch:
      - log: No cookie banner present

  # Add item to cart
  - c: ~Add to Cart
  - wait: .cart-sidebar

  # Check if user is logged in
  - if: {exists: .user-greeting}
    then:
      # Logged in - proceed to checkout
      - c: Proceed to Checkout
    else:
      # Not logged in - use guest checkout
      - c: Guest Checkout
      - wait: #email
      - t: {#email: guest@example.com}

  # Select shipping based on cart value
  - wait: .shipping-options
  - store: {.cart-total: cartTotal}
  - if:
      cond: "gt($cartTotal, 100)"
      then:
        # Free shipping available
        - c: Free Shipping
      else:
        # Select preferred shipping
        - if:
            cond: "equals($preferredShipping, 'express')"
            then:
              - c: Express Shipping
            else:
              - c: Standard Shipping

  # Handle potential promo code
  - if:
      cond: "exists(.promo-code-input)"
      then:
        - t: {.promo-code-input: SAVE10}
        - c: Apply
        - wait: .discount-applied

  # Complete order
  - c: Complete Order
  - wait: .confirmation
  - ch: "Thank you for your order"
