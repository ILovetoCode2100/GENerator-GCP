# E2E Workflow: Login Flow with Validation
# Complete login flow with error handling and multi-factor authentication

name: "Login Flow with Validation"
description: "Tests login with various scenarios including errors, validation, and MFA"

config:
  continue_on_error: false
  output_format: "json"

steps:
  # Navigate to login page
  - navigate:
      action: "to"
      url: "https://app.example.com/login"

  - wait:
      type: "element"
      target: "form#login-form"

  - misc:
      action: "comment"
      text: "=== Test 1: Empty form submission ==="

  # Test empty form submission
  - interact:
      action: "click"
      target: "button[type='submit']"

  - assert:
      type: "exists"
      target: "span.error-email"

  - assert:
      type: "equals"
      target: "span.error-email"
      expected: "Email is required"

  - misc:
      action: "comment"
      text: "=== Test 2: Invalid email format ==="

  # Test invalid email
  - interact:
      action: "write"
      target: "input#email"
      text: "invalid-email"

  - interact:
      action: "click"
      target: "button[type='submit']"

  - assert:
      type: "equals"
      target: "span.error-email"
      expected: "Please enter a valid email address"

  - misc:
      action: "comment"
      text: "=== Test 3: Valid email, no password ==="

  # Test valid email but no password
  - interact:
      action: "write"
      target: "input#email"
      text: "user@example.com"
      clear: true

  - interact:
      action: "click"
      target: "button[type='submit']"

  - assert:
      type: "equals"
      target: "span.error-password"
      expected: "Password is required"

  - misc:
      action: "comment"
      text: "=== Test 4: Incorrect credentials ==="

  # Test incorrect credentials
  - interact:
      action: "write"
      target: "input#password"
      text: "wrongpassword"

  - interact:
      action: "click"
      target: "button[type='submit']"

  - wait:
      type: "element"
      target: "div.alert-error"
      timeout: 3000

  - assert:
      type: "equals"
      target: "div.alert-error"
      expected: "Invalid email or password"

  # Store attempt count
  - data:
      action: "store"
      type: "element-text"
      target: "span.attempt-count"
      variable: "loginAttempts"

  - misc:
      action: "comment"
      text: "=== Test 5: Successful login with MFA ==="

  # Clear form and enter valid credentials
  - interact:
      action: "write"
      target: "input#email"
      text: "valid.user@example.com"
      clear: true

  - interact:
      action: "write"
      target: "input#password"
      text: "SecurePassword123!"
      clear: true

  # Check remember me
  - interact:
      action: "click"
      target: "input#remember-me"

  - assert:
      type: "checked"
      target: "input#remember-me"

  # Submit login form
  - interact:
      action: "click"
      target: "button[type='submit']"

  # Wait for MFA page
  - wait:
      type: "element"
      target: "div.mfa-container"
      timeout: 5000

  - assert:
      type: "exists"
      target: "h2.mfa-title"

  - assert:
      type: "equals"
      target: "h2.mfa-title"
      expected: "Two-Factor Authentication"

  # Enter MFA code
  - interact:
      action: "write"
      target: "input#mfa-code"
      text: "123456"

  - interact:
      action: "click"
      target: "button.verify-mfa"

  # Wait for dashboard
  - wait:
      type: "element"
      target: "div.dashboard"
      timeout: 5000

  # Verify successful login
  - assert:
      type: "exists"
      target: "nav.user-menu"

  - assert:
      type: "equals"
      target: "span.user-email"
      expected: "valid.user@example.com"

  # Store user session data
  - data:
      action: "store"
      type: "element-text"
      target: "span.user-role"
      variable: "userRole"

  - data:
      action: "store"
      type: "attribute"
      target: "div.dashboard"
      attribute: "data-user-id"
      variable: "userId"

  # Test session persistence
  - navigate:
      action: "to"
      url: "https://app.example.com/profile"

  - wait:
      type: "element"
      target: "div.profile-page"

  - assert:
      type: "exists"
      target: "h1.profile-title"

  # Test logout
  - interact:
      action: "hover"
      target: "div.user-dropdown"

  - wait:
      type: "element"
      target: "ul.dropdown-menu"

  - interact:
      action: "click"
      target: "a.logout-link"

  # Handle logout confirmation dialog
  - wait:
      type: "element"
      target: "div.modal-dialog"

  - assert:
      type: "equals"
      target: "div.modal-body p"
      expected: "Are you sure you want to logout?"

  - interact:
      action: "click"
      target: "button.confirm-logout"

  # Verify redirect to login
  - wait:
      type: "element"
      target: "form#login-form"
      timeout: 3000

  - assert:
      type: "equals"
      target: "div.alert-info"
      expected: "You have been logged out successfully"

  # Verify session cleared
  - data:
      action: "cookie"
      operation: "delete"
      name: "session_id"

  - misc:
      action: "comment"
      text: "=== Login Flow Completed Successfully ==="
