# Virtuoso API CLI - GCP Service Dependency Map
# This file defines the relationships and dependencies between GCP services

version: "1.0"
project: virtuoso-api-cli
environment: production

# Service definitions with their dependencies and configurations
services:
  # Frontend Services
  cloud-cdn:
    type: edge
    purpose: Global content delivery and caching
    depends_on:
      - cloud-load-balancer
    configuration:
      cache_ttl: 300
      negative_caching: true
      regions: global

  cloud-load-balancer:
    type: network
    purpose: HTTPS load balancing and SSL termination
    depends_on:
      - cloud-run-api
      - cloud-functions-health
    configuration:
      protocol: HTTPS
      ssl_policy: modern
      backend_timeout: 60s

  # Compute Services
  cloud-run-api:
    type: compute
    purpose: Main FastAPI service hosting
    depends_on:
      - firestore
      - memorystore
      - cloud-tasks
      - pub-sub
      - secret-manager
      - identity-platform
    configuration:
      cpu: 2
      memory: 4Gi
      min_instances: 0
      max_instances: 1000
      concurrency: 100
    environment:
      - FIRESTORE_PROJECT
      - MEMORYSTORE_HOST
      - PUBSUB_PROJECT
      - TASKS_QUEUE
    service_account: api-cli-runner@project.iam

  cloud-functions-health:
    type: compute
    purpose: Health check endpoint
    depends_on:
      - firestore
      - secret-manager
    configuration:
      memory: 256Mi
      timeout: 30s
      max_instances: 100
    triggers:
      - type: http
        path: /health

  cloud-functions-webhooks:
    type: compute
    purpose: Webhook processing
    depends_on:
      - pub-sub
      - secret-manager
    configuration:
      memory: 512Mi
      timeout: 60s
      max_instances: 500
    triggers:
      - type: http
        path: /webhook/*

  cloud-functions-events:
    type: compute
    purpose: Event processing
    depends_on:
      - firestore
      - cloud-storage
    configuration:
      memory: 1Gi
      timeout: 540s
      max_instances: 1000
    triggers:
      - type: pubsub
        topic: command-events
      - type: pubsub
        topic: test-events

  # Data Services
  firestore:
    type: database
    purpose: NoSQL database for sessions and metadata
    depends_on: []
    configuration:
      mode: NATIVE
      locations:
        - us-central1
      collections:
        - sessions
        - test_runs
        - user_preferences
        - command_history
    backup:
      schedule: "0 2 * * *"  # Daily at 2 AM
      retention: 30d
      destination: cloud-storage

  memorystore:
    type: cache
    purpose: High-speed Redis-compatible cache
    depends_on:
      - vpc-network
    configuration:
      tier: STANDARD_HA
      memory: 1Gi
      version: REDIS_6_X
      auth: enabled
      tls: enabled
    cache_patterns:
      - pattern: "session:*"
        ttl: 3600
      - pattern: "api:response:*"
        ttl: 300
      - pattern: "command:result:*"
        ttl: 1800

  cloud-storage:
    type: storage
    purpose: Object storage for logs and artifacts
    depends_on: []
    configuration:
      storage_class: STANDARD
      location: US
      versioning: true
    buckets:
      - name: virtuoso-api-logs
        lifecycle:
          delete_after: 30d
      - name: virtuoso-api-artifacts
        lifecycle:
          nearline_after: 7d
          coldline_after: 90d
      - name: virtuoso-api-backups
        lifecycle:
          coldline_after: 1d

  # Messaging Services
  cloud-tasks:
    type: queue
    purpose: Asynchronous task execution
    depends_on:
      - cloud-run-api
    configuration:
      max_concurrent: 1000
      max_rate: 100/s
    queues:
      - name: command-execution
        retry_config:
          max_attempts: 5
          max_backoff: 3600s
      - name: test-execution
        retry_config:
          max_attempts: 3
          max_backoff: 1800s

  pub-sub:
    type: messaging
    purpose: Event streaming and service decoupling
    depends_on: []
    configuration:
      message_retention: 7d
      ack_deadline: 600s
    topics:
      - name: command-events
        subscriptions:
          - name: command-processor
            type: push
            endpoint: cloud-run-api
          - name: command-logger
            type: push
            endpoint: cloud-functions-events
      - name: test-events
        subscriptions:
          - name: test-executor
            type: push
            endpoint: cloud-run-api
          - name: test-analyzer
            type: push
            endpoint: cloud-functions-events
      - name: system-events
        subscriptions:
          - name: monitoring
            type: pull
          - name: alerting
            type: push
            endpoint: cloud-functions-events

  # Security Services
  secret-manager:
    type: security
    purpose: Secure credential storage
    depends_on: []
    configuration:
      replication: automatic
      rotation: enabled
    secrets:
      - name: virtuoso-api-key
        rotation_period: 90d
      - name: memorystore-host
      - name: service-account-keys
      - name: tls-certificates
        rotation_period: 365d

  identity-platform:
    type: security
    purpose: API key and authentication management
    depends_on:
      - firestore
    configuration:
      api_key_restrictions: SERVER
      quota_enforcement: true
    quotas:
      - type: requests_per_minute
        limit: 1000
      - type: requests_per_day
        limit: 100000

  # Infrastructure Services
  vpc-network:
    type: network
    purpose: Virtual private cloud for internal communication
    depends_on: []
    configuration:
      mode: auto
      private_google_access: true
    subnets:
      - name: default
        region: us-central1
        range: 10.0.0.0/24

  cloud-armor:
    type: security
    purpose: DDoS and application security
    depends_on:
      - cloud-load-balancer
    configuration:
      security_policy: default
      rules:
        - priority: 1000
          action: rate_based_ban
          rate_limit_threshold: 1000
        - priority: 2000
          action: deny
          source_ranges:
            - known_bad_ips

  # CI/CD Services
  cloud-build:
    type: ci-cd
    purpose: Automated build and deployment
    depends_on:
      - cloud-source-repositories
      - container-registry
      - cloud-run-api
    configuration:
      machine_type: E2_HIGHCPU_8
      timeout: 1200s
    triggers:
      - name: main-branch
        type: github
        branch: main
        filename: cloudbuild.yaml

  container-registry:
    type: storage
    purpose: Docker image storage
    depends_on: []
    configuration:
      location: US
      vulnerability_scanning: true

  cloud-source-repositories:
    type: vcs
    purpose: Git repository mirror
    depends_on: []
    configuration:
      sync_from: github
      repo: virtuoso-api-cli

  # Monitoring Services
  cloud-monitoring:
    type: observability
    purpose: Metrics and alerting
    depends_on:
      - all_services
    configuration:
      retention: 30d
      sampling_rate: 1.0
    alerts:
      - name: high-error-rate
        condition: error_rate > 0.05
        duration: 5m
      - name: high-latency
        condition: p95_latency > 1000ms
        duration: 5m

  cloud-logging:
    type: observability
    purpose: Centralized logging
    depends_on:
      - all_services
    configuration:
      retention: 30d
      include_audit_logs: true
    sinks:
      - name: security-logs
        destination: bigquery
        filter: severity >= WARNING
      - name: api-analytics
        destination: cloud-storage
        filter: api_requests

  cloud-trace:
    type: observability
    purpose: Distributed tracing
    depends_on:
      - cloud-run-api
      - cloud-functions-events
    configuration:
      sampling_rate: 0.1
      latency_percentiles:
        - 50
        - 95
        - 99

# Service dependency chains (critical paths)
critical_paths:
  api_request:
    description: Standard API request flow
    path:
      - cloud-cdn
      - cloud-load-balancer
      - cloud-run-api
      - firestore
      - memorystore
    sla: 200ms p95

  async_command:
    description: Asynchronous command execution
    path:
      - cloud-run-api
      - cloud-tasks
      - cloud-run-api
      - pub-sub
      - cloud-functions-events
    sla: 5s p95

  webhook_processing:
    description: External webhook handling
    path:
      - cloud-load-balancer
      - cloud-functions-webhooks
      - pub-sub
      - cloud-functions-events
      - firestore
    sla: 1s p95

# Failure scenarios and dependencies
failure_modes:
  firestore_outage:
    impact: critical
    affected_services:
      - cloud-run-api
      - cloud-functions-health
      - cloud-functions-events
    mitigation:
      - multi-region replication
      - cache fallback in memorystore

  memorystore_outage:
    impact: moderate
    affected_services:
      - cloud-run-api
    mitigation:
      - graceful degradation
      - direct firestore access

  cloud_tasks_outage:
    impact: moderate
    affected_services:
      - async command execution
    mitigation:
      - in-memory queue fallback
      - pub-sub alternative path

# Cross-service authentication
authentication:
  service_accounts:
    api-cli-runner:
      services:
        - firestore: datastore.user
        - memorystore: redis.editor
        - cloud-tasks: cloudtasks.enqueuer
        - pub-sub: pubsub.publisher
        - secret-manager: secretmanager.secretAccessor
        - cloud-storage: storage.objectCreator

    function-executor:
      services:
        - firestore: datastore.viewer
        - pub-sub: pubsub.subscriber
        - secret-manager: secretmanager.secretAccessor
        - cloud-storage: storage.objectViewer

    ci-cd-builder:
      services:
        - cloud-run-api: run.developer
        - container-registry: storage.admin
        - cloud-build: cloudbuild.builds.builder

# Network flow rules
network_flows:
  ingress:
    - from: internet
      to: cloud-cdn
      protocol: HTTPS
      port: 443

    - from: cloud-cdn
      to: cloud-load-balancer
      protocol: HTTPS
      port: 443

  internal:
    - from: cloud-run-api
      to: firestore
      protocol: gRPC
      port: 443

    - from: cloud-run-api
      to: memorystore
      protocol: Redis
      port: 6379

    - from: cloud-functions-*
      to: pub-sub
      protocol: HTTPS
      port: 443

  egress:
    - from: cloud-run-api
      to: virtuoso-api
      protocol: HTTPS
      port: 443

# Monitoring dependencies
monitoring_dependencies:
  metrics:
    - service: cloud-run-api
      metrics:
        - request_count
        - request_latency
        - error_rate
        - cpu_utilization
        - memory_utilization
        - concurrent_requests

    - service: firestore
      metrics:
        - read_ops
        - write_ops
        - storage_size
        - index_usage

    - service: memorystore
      metrics:
        - memory_usage
        - hit_rate
        - eviction_rate
        - connection_count

  logs:
    - service: cloud-run-api
      log_types:
        - access_logs
        - application_logs
        - error_logs

    - service: cloud-functions-*
      log_types:
        - function_logs
        - system_logs

  traces:
    - service: cloud-run-api
      trace_types:
        - http_requests
        - database_queries
        - cache_operations
        - external_api_calls
