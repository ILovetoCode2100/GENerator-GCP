# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**API CLI Generator - Virtuoso Edition** - A Go-based CLI tool that generates an intelligent orchestration interface for the Virtuoso API. It automatically creates CLI commands from OpenAPI specifications and provides advanced batch test structure creation and workflow automation.

**Technology Stack**:
- Go 1.21+ (primary language)
- Cobra (CLI framework)
- Viper (configuration management)
- oapi-codegen (OpenAPI code generation)
- go-resty/resty/v2 (HTTP client with retry logic)

## Key Commands

### Development
```bash
# Generate API client from OpenAPI spec
make generate

# Build the CLI binary
make build

# Run tests
make test

# Clean build artifacts
make clean

# Quick validation test
./test/quick-test.sh

# Run specific feature tests
./test-batch-create.sh
./test-yaml-processing.sh
```

### Docker
```bash
# Build Docker image
make docker-build

# Run with Docker Compose
docker-compose up

# Run Docker container
docker run -v $(pwd)/config:/app/config api-cli
```

### CLI Usage
```bash
# Set API token (required)
export VIRTUOSO_API_TOKEN="your-token"

# Validate configuration
./bin/api-cli validate-config

# Run batch creation
./bin/api-cli create-structure --file examples/test-structure.yaml

# List goals
./bin/api-cli list-goals 123

# Create journey with checkpoints
./bin/api-cli create-journey 123 1 "My Journey"

# Create individual test steps (39 commands available)
./bin/api-cli create-step-navigate 1678318 "https://example.com" 1
./bin/api-cli create-step-click 1678318 "Sign in button" 2
./bin/api-cli create-step-write 1678318 "user@example.com" "Email field" 3
./bin/api-cli create-step-assert-exists 1678318 "Welcome message" 4
# See STEP_COMMANDS.md for all 39 step creation commands
```

## Architecture

### Code Generation Flow
```
OpenAPI Spec (specs/api.yaml) 
    → oapi-codegen 
    → Generated Client (src/api/)
    → Enhanced Client (src/client/client.go) 
    → CLI Commands (src/cmd/)
```

### Directory Structure
- `/src/api/` - Generated API client code (DO NOT EDIT - regenerated by `make generate`)
- `/src/client/` - Enhanced client wrapper with retry logic and error handling
- `/src/cmd/` - Cobra CLI command implementations (one file per command)
- `/pkg/virtuoso/` - Virtuoso-specific client implementation with all step methods
- `/pkg/config/` - Configuration management
- `/examples/` - Example YAML/JSON batch structure files
- `/test/` - Integration test scripts

### Key Design Patterns
1. **Command Pattern**: Each CLI command is a separate file in `/src/cmd/` following the pattern `newCreateStep*Cmd()`
2. **Enhanced Client**: Wraps generated client with retry logic, logging, and Virtuoso-specific business rules
3. **Configuration Hierarchy**: CLI flags → Environment variables → Config file → Defaults

## Important Implementation Details

### API Configuration
- **Base URL**: https://api-app2.virtuoso.qa/api
- **Organization ID**: 2242 (hardcoded)
- **Headers**: `X-Virtuoso-Client-ID` and `X-Virtuoso-Client-Name` required
- **Authentication**: Bearer token via `VIRTUOSO_API_TOKEN` environment variable
- **Config File**: `config/virtuoso-config.yaml`

### Business Rules
1. Goals automatically create first journey ("Suite 1")
2. Journey `name` is system-generated (Suite 1, Suite 2), `title` is user-friendly
3. First checkpoint in each journey must be navigation type
4. Checkpoints auto-attach to journeys at specified positions
5. Step positions determine execution order

### Error Handling
- All API errors wrapped with context
- Retry logic for transient failures (429, 500-503)
- Verbose error messages with API response details
- Dry-run mode for validation without changes

### Testing Strategy
- Integration tests via shell scripts in `/test/`
- Manual testing scripts (`test-*.sh`) for specific features
- No Go unit tests currently (uses integration approach)

## Common Development Tasks

### Adding New Commands
1. Add method to `/pkg/virtuoso/client.go` following existing patterns
2. Create command file in `/src/cmd/create-step-[name].go`
3. Register in `/src/cmd/main.go` with `rootCmd.AddCommand(newCreateStep*Cmd())`
4. Follow output format patterns (human, json, yaml, ai)
5. Update documentation in COMMANDS.md and STEP_COMMANDS.md

### Modifying API Client
1. Update `/specs/api.yaml` with API changes
2. Run `make generate` to regenerate client
3. Update enhanced client wrapper if needed
4. Test with integration scripts

### Configuration Changes
1. Update `/pkg/config/config.go` for new fields
2. Add to `/config/virtuoso-config.yaml` template
3. Support environment variable override (VIRTUOSO_ prefix)

## Step Commands (39 total)

All step commands follow the pattern:
```bash
./bin/api-cli create-step-[type] CHECKPOINT_ID [params...] POSITION
```

Step types include:
- **Navigation**: navigate, wait-time, wait-element, window
- **Mouse**: click, double-click, right-click, hover, mouse-down/up/move/enter
- **Input**: write, key, pick, pick-value, pick-text, upload
- **Scroll**: scroll-top/bottom/element/position
- **Assert**: assert-exists/not-exists/equals/checked/selected/variable/less-than-or-equal
- **Data**: store, store-value, execute-js
- **Environment**: add-cookie, delete-cookie, clear-cookies
- **Dialog**: dismiss-alert, dismiss-confirm, dismiss-prompt
- **Other**: comment

## Batch Structure Format
```yaml
project:
  name: "Project Name"  # Or use existing: id: 1234
goals:
  - name: "Goal Name"
    url: "https://example.com"
    journeys:
      - name: "Journey Title"  # Renames auto-created journey
        checkpoints:
          - name: "Checkpoint Name"
            navigation_url: "https://example.com"  # Updates existing
            steps:
              - type: click
                selector: "button"
```

## Common Development Tasks

### Testing Step Commands
```bash
# Create test checkpoint
CHECKPOINT_ID=$(./bin/api-cli create-checkpoint $JOURNEY_ID $GOAL_ID $SNAPSHOT_ID "Test" -o json | jq -r .checkpoint_id)

# Test step creation
./bin/api-cli create-step-navigate $CHECKPOINT_ID "https://example.com" 1
./bin/api-cli create-step-click $CHECKPOINT_ID "Submit" 2
./bin/api-cli create-step-assert-exists $CHECKPOINT_ID "Success" 3

# List checkpoint steps
./bin/api-cli list-checkpoints $JOURNEY_ID -o json
```

## Notes
- Generated code in `/src/api/` is overwritten by `make generate`
- Always use enhanced client (`virtuoso.NewClient()`) not raw generated client
- Step IDs in responses are typically 1 (API limitation)
- Some step types require specific meta fields (e.g., MOUSE actions need meta.action)
- Pick text uses `type: "VISIBLE_TEXT"` not `"TEXT"`
- Assert variable requires `type: "EQUALS"` in meta