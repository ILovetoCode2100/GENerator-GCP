# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**API CLI Generator - Virtuoso Edition** - A comprehensive Go-based CLI tool that provides an intelligent orchestration interface for the Virtuoso API. It features 69 commands including test automation, execution monitoring, analytics, and workflow management with advanced session context management.

**Technology Stack**:
- Go 1.21+ (primary language)
- Cobra (CLI framework)
- Viper (configuration management)
- oapi-codegen (OpenAPI code generation)
- go-resty/resty/v2 (HTTP client with retry logic)

## Key Commands

### Development
```bash
# Generate API client from OpenAPI spec
make generate

# Build the CLI binary
make build

# Run tests
make test

# Clean build artifacts
make clean

# Quick validation test
./test/quick-test.sh

# Run specific feature tests
./test-batch-create.sh
./test-yaml-processing.sh
```

### Docker
```bash
# Build Docker image
make docker-build

# Run with Docker Compose
docker-compose up

# Run Docker container
docker run -v $(pwd)/config:/app/config api-cli
```

### CLI Usage
```bash
# Set API token (required)
export VIRTUOSO_API_TOKEN="your-token"

# Validate configuration
./bin/api-cli validate-config

# Run batch creation
./bin/api-cli create-structure --file examples/test-structure.yaml

# List goals
./bin/api-cli list-goals 123

# Create journey with checkpoints
./bin/api-cli create-journey 123 1 "My Journey"

# Set current checkpoint context (NEW: Stateful Context Management)
./bin/api-cli set-checkpoint 1678318

# Create individual test steps using session context (39 commands available)
./bin/api-cli create-step-navigate "https://example.com" 1
./bin/api-cli create-step-click "Sign in button" 2
./bin/api-cli create-step-write "user@example.com" "Email field" 3
./bin/api-cli create-step-assert-exists "Welcome message" 4

# Auto-increment position (no position argument needed)
./bin/api-cli create-step-navigate "https://example.com"    # Position 1
./bin/api-cli create-step-click "Submit"                   # Position 2
./bin/api-cli create-step-assert-exists "Success"         # Position 3

# Override checkpoint for specific steps
./bin/api-cli create-step-click "Submit" 2 --checkpoint 1678319
```

## Architecture

### Code Generation Flow
```
OpenAPI Spec (specs/api.yaml) 
    → oapi-codegen 
    → Generated Client (src/api/)
    → Enhanced Client (src/client/client.go) 
    → CLI Commands (src/cmd/)
```

### Directory Structure
- `/src/api/` - Generated API client code (DO NOT EDIT - regenerated by `make generate`)
- `/src/client/` - Enhanced client wrapper with retry logic and error handling
- `/src/cmd/` - Cobra CLI command implementations (one file per command)
- `/src/cmd/step_helpers.go` - Shared helper functions for step commands
- `/pkg/virtuoso/` - Virtuoso-specific client implementation with all step methods
- `/pkg/config/` - Configuration management with session state
- `/examples/` - Example YAML/JSON batch structure files
- `/test/` - Integration test scripts

### Key Design Patterns
1. **Command Pattern**: Each CLI command is a separate file in `/src/cmd/` following the pattern `newCreateStep*Cmd()`
2. **Enhanced Client**: Wraps generated client with retry logic, logging, and Virtuoso-specific business rules
3. **Stateful Context Management**: Session-based checkpoint and position tracking for improved UX
4. **Configuration Hierarchy**: CLI flags → Environment variables → Config file → Defaults
5. **Shared Helper Functions**: Common logic in `step_helpers.go` for consistent behavior

## Important Implementation Details

### API Configuration
- **Base URL**: https://api-app2.virtuoso.qa/api
- **Organization ID**: 2242 (hardcoded)
- **Headers**: `X-Virtuoso-Client-ID` and `X-Virtuoso-Client-Name` required
- **Authentication**: Bearer token via `VIRTUOSO_API_TOKEN` environment variable
- **Config File**: `config/virtuoso-config.yaml`

### Business Rules
1. Goals automatically create first journey ("Suite 1")
2. Journey `name` is system-generated (Suite 1, Suite 2), `title` is user-friendly
3. First checkpoint in each journey must be navigation type
4. Checkpoints auto-attach to journeys at specified positions
5. Step positions determine execution order
6. Session context persists checkpoint ID and auto-increments position
7. Current checkpoint set via `set-checkpoint` command or config file

### Error Handling
- All API errors wrapped with context
- Retry logic for transient failures (429, 500-503)
- Verbose error messages with API response details
- Dry-run mode for validation without changes

### Testing Strategy
- Integration tests via shell scripts in `/test/`
- Manual testing scripts (`test-*.sh`) for specific features
- No Go unit tests currently (uses integration approach)

## Common Development Tasks

### Adding New Commands
1. Add method to `/pkg/virtuoso/client.go` following existing patterns
2. Create command file in `/src/cmd/create-step-[name].go` using helper functions
3. Register in `/src/cmd/main.go` with `rootCmd.AddCommand(newCreateStep*Cmd())`
4. Use `step_helpers.go` functions for consistent behavior:
   - `resolveStepContext()` for checkpoint/position resolution
   - `saveStepContext()` for session state persistence
   - `outputStepResult()` for consistent output formatting
   - `addCheckpointFlag()` for standard --checkpoint flag
5. Follow output format patterns (human, json, yaml, ai)
6. Update documentation in COMMANDS.md and STEP_COMMANDS.md

### Modifying API Client
1. Update `/specs/api.yaml` with API changes
2. Run `make generate` to regenerate client
3. Update enhanced client wrapper if needed
4. Test with integration scripts

### Configuration Changes
1. Update `/pkg/config/virtuoso.go` for new fields
2. Add to `/config/virtuoso-config.yaml` template
3. Support environment variable override (VIRTUOSO_ prefix)
4. Session state automatically saved to config file

## Step Commands (39 total)

All step commands follow the new stateful pattern:
```bash
# Set checkpoint context once
./bin/api-cli set-checkpoint CHECKPOINT_ID

# Create steps using session context (no checkpoint ID needed)
./bin/api-cli create-step-[type] [params...] [POSITION]

# Or override checkpoint for specific steps
./bin/api-cli create-step-[type] [params...] [POSITION] --checkpoint CHECKPOINT_ID
```

Step types include:
- **Navigation**: navigate, wait-time, wait-element, window
- **Mouse**: click, double-click, right-click, hover, mouse-down/up/move/enter
- **Input**: write, key, pick, pick-value, pick-text, upload
- **Scroll**: scroll-top/bottom/element/position
- **Assert**: assert-exists/not-exists/equals/checked/selected/variable/less-than-or-equal
- **Data**: store, store-value, execute-js
- **Environment**: add-cookie, delete-cookie, clear-cookies
- **Dialog**: dismiss-alert, dismiss-confirm, dismiss-prompt
- **Other**: comment

## Batch Structure Format
```yaml
project:
  name: "Project Name"  # Or use existing: id: 1234
goals:
  - name: "Goal Name"
    url: "https://example.com"
    journeys:
      - name: "Journey Title"  # Renames auto-created journey
        checkpoints:
          - name: "Checkpoint Name"
            navigation_url: "https://example.com"  # Updates existing
            steps:
              - type: click
                selector: "button"
```

## Common Development Tasks

### Testing Step Commands
```bash
# Create test checkpoint
CHECKPOINT_ID=$(./bin/api-cli create-checkpoint $JOURNEY_ID $GOAL_ID $SNAPSHOT_ID "Test" -o json | jq -r .checkpoint_id)

# Set checkpoint context
./bin/api-cli set-checkpoint $CHECKPOINT_ID

# Test step creation using session context
./bin/api-cli create-step-navigate "https://example.com" 1
./bin/api-cli create-step-click "Submit" 2
./bin/api-cli create-step-assert-exists "Success" 3

# Or with auto-increment position
./bin/api-cli create-step-navigate "https://example.com"    # Position 1
./bin/api-cli create-step-click "Submit"                   # Position 2
./bin/api-cli create-step-assert-exists "Success"         # Position 3

# List checkpoint steps
./bin/api-cli list-checkpoints $JOURNEY_ID -o json
```

## Session Context Management

The CLI now supports stateful context management for improved user experience:

### Configuration Structure
```yaml
session:
  current_project_id: null
  current_goal_id: null
  current_snapshot_id: null
  current_journey_id: null
  current_checkpoint_id: 1678318  # Set by set-checkpoint command
  auto_increment_position: true
  next_position: 3  # Auto-increments after each step
```

### Key Commands
- `set-checkpoint CHECKPOINT_ID` - Set current checkpoint context
- `create-step-* [params] [POSITION]` - Create steps using session context
- `--checkpoint CHECKPOINT_ID` - Override session context for specific commands

### Session Management Methods
- `cfg.SetCurrentCheckpoint(id)` - Set checkpoint and reset position
- `cfg.GetCurrentCheckpoint()` - Get current checkpoint ID
- `cfg.GetNextPosition()` - Get next position and auto-increment
- `cfg.SaveConfig()` - Persist session state to config file

## Notes
- Generated code in `/src/api/` is overwritten by `make generate`
- Always use enhanced client (`virtuoso.NewClient()`) not raw generated client
- Step IDs in responses are typically 1 (API limitation)
- Some step types require specific meta fields (e.g., MOUSE actions need meta.action)
- Pick text uses `type: "VISIBLE_TEXT"` not `"TEXT"`
- Assert variable requires `type: "EQUALS"` in meta
- Session state persists between CLI invocations via config file
- Use `step_helpers.go` functions for consistent command behavior